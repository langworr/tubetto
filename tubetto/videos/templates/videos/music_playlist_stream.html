{% extends "base.html" %}
{% block content %}
<h1>{{ playlist.title }}{% if is_shuffle %} (Shuffle){% endif %}</h1>
<p>
  <a href="{% url 'music_playlist_detail' playlist.id %}">Back to playlist details</a> |
  <a href="{% url 'music_playlist_stream' playlist.id %}?format=m3u{% if is_shuffle %}&shuffle=1{% endif %}">Download M3U</a>
</p>

{% if tracks_payload %}
  <section style="margin-bottom: 1.5rem;">
    <p id="now-playing" style="font-weight: bold;">Loading…</p>
    <audio id="playlist-audio" controls autoplay style="width:100%;"></audio>
    <div style="margin-top: 0.75rem; display:flex; gap:0.5rem;">
      <button id="prev-track" type="button" style="padding:0.5rem 1rem;">Previous</button>
      <button id="next-track" type="button" style="padding:0.5rem 1rem;">Next</button>
      <span id="track-counter" style="align-self:center;"></span>
    </div>
  </section>

  <table style="width:100%; border-collapse: collapse;">
    <thead>
      <tr style="text-align:left; border-bottom: 1px solid #ccc;">
        <th style="padding: 0.5rem;">#</th>
        <th style="padding: 0.5rem;">Title</th>
        <th style="padding: 0.5rem;">Artist</th>
        <th style="padding: 0.5rem;">Duration</th>
      </tr>
    </thead>
    <tbody>
    {% for track in tracks_payload %}
      <tr data-index="{{ forloop.counter0 }}" style="border-bottom: 1px solid #eee;">
        <td style="padding: 0.5rem;">{{ forloop.counter }}</td>
        <td style="padding: 0.5rem;">{{ track.title }}</td>
        <td style="padding: 0.5rem;">{{ track.artist|default:"—" }}</td>
        <td style="padding: 0.5rem;">{{ track.duration|default:"—" }}</td>
      </tr>
    {% endfor %}
    </tbody>
  </table>

  {{ tracks_payload|json_script:"playlist-data" }}
{% else %}
  <p>No tracks in this playlist.</p>
{% endif %}

<script>
const dataElement = document.getElementById('playlist-data');
if (dataElement) {
  const tracks = JSON.parse(dataElement.textContent);
  const audioEl = document.getElementById('playlist-audio');
  const nowPlayingEl = document.getElementById('now-playing');
  const trackCounterEl = document.getElementById('track-counter');
  const rows = Array.from(document.querySelectorAll('tbody tr'));
  let currentIndex = -1;

  function highlightRow(index) {
    rows.forEach((row, i) => {
      row.style.backgroundColor = i === index ? '#eef5ff' : '';
    });
  }

  function playIndex(index) {
    if (!tracks.length) {
      return;
    }
    if (index < 0) index = 0;
    if (index >= tracks.length) {
      audioEl.pause();
      nowPlayingEl.textContent = 'Playlist finished.';
      trackCounterEl.textContent = '';
      highlightRow(-1);
      return;
    }
    currentIndex = index;
    const track = tracks[currentIndex];
    audioEl.src = track.stream_url;
    audioEl.play().catch(() => {});
    const artist = track.artist ? ` — ${track.artist}` : '';
    nowPlayingEl.textContent = `Now playing: ${track.title}${artist}`;
    trackCounterEl.textContent = `${currentIndex + 1} / ${tracks.length}`;
    highlightRow(currentIndex);
  }

  audioEl.addEventListener('ended', () => playIndex(currentIndex + 1));
  document.getElementById('next-track').addEventListener('click', () => playIndex(currentIndex + 1));
  document.getElementById('prev-track').addEventListener('click', () => playIndex(currentIndex - 1));
  rows.forEach(row => {
    row.addEventListener('click', () => {
      const idx = Number(row.dataset.index);
      playIndex(idx);
    });
  });
  playIndex(0);
}
</script>
{% endblock %}

